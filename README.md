# 지불 / 환불 신청서 웹 서비스

대회 운영을 위한 지불/환불 신청, 승인, 정산 웹 서비스입니다. 프로젝트(대회) 단위로 데이터를 관리하며, 한국어/영어 전환을 지원합니다.

## 프로젝트(대회) 관리

서비스는 **프로젝트(대회)** 단위로 운영됩니다. 각 프로젝트는 독립적인 신청/정산 프로세스와 예산을 가집니다.

- Admin이 **설정 > 프로젝트 설정** 탭에서 프로젝트를 생성/삭제/편집합니다.
- 프로젝트별로 Document No., 예산, 멤버, 승인 금액 기준을 설정합니다.
- 여러 프로젝트에 할당된 사용자는 상단 드롭다운으로 프로젝트를 전환합니다.
- 1개 프로젝트만 할당된 사용자는 자동 선택되며 드롭다운이 표시되지 않습니다.
- 신규 가입자는 기본 프로젝트에 자동 할당됩니다.

#### 프로젝트 삭제

프로젝트 삭제는 **소프트 삭제** 방식으로 동작합니다:

1. 프로젝트를 삭제하면 즉시 삭제되지 않고 **비활성화** 상태가 됩니다.
2. 삭제된 프로젝트는 프로젝트 설정 하단에 남은 일수와 함께 표시됩니다.
3. 30일 이내에 **복원** 버튼으로 되돌릴 수 있습니다.
4. 30일이 지나면 Cloud Functions의 스케줄 작업이 자동으로 **영구 삭제**합니다.
   - 해당 프로젝트의 모든 신청서, 정산 데이터, 영수증 파일이 함께 삭제됩니다.

## 시작하기

### 최초 로그인

1. Google 계정으로 로그인합니다.
2. 최초 로그인 시 기본 정보를 입력하는 화면이 나타납니다.
   - **선호하는 이름** - 통장사본에 기재된 이름과 동일해야 합니다
   - **전화번호** - 연락처 (자동 포맷: 010-0000-0000)
   - **은행 / 계좌번호** - 환불 수령 계좌
   - **소속 위원회** - 운영 위원회 또는 준비 위원회
3. 정보를 입력하고 "시작하기"를 누르면 서비스를 이용할 수 있습니다.

### 통장사본 등록 (필수)

신청서 제출 전에 반드시 통장사본을 등록해야 합니다.

1. 상단 우측의 톱니바퀴 아이콘을 클릭하여 설정으로 이동합니다.
2. **통장사본** 영역에서 파일을 선택하고 **업로드**를 클릭합니다.
3. 업로드 완료 후 미리보기가 표시됩니다.
4. 통장사본은 Firebase Storage에 안전하게 저장됩니다.

> 통장사본이 등록되지 않으면 신청서를 제출할 수 없습니다.

---

## 일반 사용자 기능

### 신청서 작성

1. 상단 메뉴에서 **새 신청서**를 클릭합니다.
2. 다음 항목을 입력합니다.
   - **신청자, 전화번호, 은행, 계좌번호** - 설정에서 저장한 정보가 자동으로 채워집니다.
   - **날짜** - 지출이 발생한 날짜
   - **위원회** - 소속 위원회가 자동 선택되며, 변경 가능합니다.
   - **항목** - 지출 내역을 입력합니다. (설명, 예산 코드, 금액)
     - "**+ 항목 추가**"로 최대 10개까지 추가할 수 있습니다.
     - 불필요한 항목은 X 버튼으로 삭제합니다.
   - **영수증** - PNG, JPG, PDF 파일만 가능 (파일당 최대 2MB)
   - **비고** - 추가 설명이 필요한 경우 입력합니다.
3. **신청서 제출**을 누르면 확인 모달이 나타납니다.
   - 항목 총액과 영수증 금액이 일치하는지 확인해주세요.
   - "확인 및 제출"을 누르면 신청이 완료됩니다.

#### 필수 항목

신청자, 전화번호, 은행, 계좌번호, 날짜, 항목(1개 이상), 예산 코드, 영수증, 통장사본이 모두 입력/등록되어야 제출할 수 있습니다.

#### 작성 중 임시저장 (Draft)

- 신청서 작성 중 내용이 **자동으로 임시저장**됩니다.
- 설정 페이지에 갔다 와도 작성 내용이 유지됩니다.
- 다른 페이지로 이동하려 하면 알림이 표시됩니다.
- 영수증 파일은 임시저장에 포함되지 않습니다.
- 신청서 제출 완료 시 임시저장 내용은 자동 삭제됩니다.

### 예산 코드 안내

| 코드 | 한국어 | English |
|------|--------|---------|
| 5862 | 숙박/시설 | Lodging/Facilities |
| 5110 | 교통비 | Transportation |
| 5400 | 식비/보험/행정 | Food/Insurance/Admin |
| 5200 | 물품/용품 | Materials/Supplies |
| 4500 | 참가비 | Participation Fee |

### 내 신청 내역 확인

1. 상단 메뉴에서 **내 신청 내역**을 클릭합니다.
2. 제출한 신청서 목록이 표시됩니다.
   - **대기중** - 재정 담당자 검토 대기 상태
   - **검토완료** - 재정 검토 완료, 최종 승인 대기 상태
   - **승인** - 최종 승인 완료
   - **반려** - 반려됨 (사유 확인 가능, 수정 후 재신청 가능)
   - **정산완료** - 정산 처리 완료
3. 날짜를 클릭하면 신청서 상세 내용을 확인할 수 있습니다.

### 반려된 신청서 재신청

1. 반려된 신청서 상세에서 반려 사유를 확인합니다.
2. **수정 후 재신청** 버튼을 클릭합니다.
3. 원본 데이터가 폼에 자동 채워지며, 최소 1개 이상 변경해야 제출할 수 있습니다.
4. 영수증을 새로 첨부하지 않으면 기존 영수증이 유지됩니다.
5. 재신청된 신청서는 검토/승인 화면에서 "재신청" 배지와 함께 이전 반려 사유가 표시됩니다.

### 설정 변경

상단 우측의 톱니바퀴 아이콘을 클릭하면 설정 페이지로 이동합니다.

**일반 사용자:**
- 언어, 이름, 연락처, 은행/계좌, 통장사본, 위원회, 서명

**관리자 (Admin):** 2개 탭
- **프로젝트 설정** - 프로젝트 생성/삭제, Document No., 예산, 멤버 관리, 기본 프로젝트 지정
- **내 설정** - 개인 정보 (일반 사용자와 동일)

---

## 승인자 / 관리자 기능

### 권한 종류

| 권한 | 코드 | 설명 |
|------|------|------|
| **일반 사용자** | `user` | 신청서 작성 및 조회 |
| **운영위 재정** | `finance_ops` | 운영위 신청서 검토/반려 |
| **운영위 승인자** | `approver_ops` | 운영위 검토완료 건 최종 승인/반려 (≤한도) |
| **준비위 재정(총괄)** | `finance_prep` | 모든 위원회 검토/반려, 정산, 승인건 반려, 영수증·대시보드·예산·사용자 관리 |
| **준비위 승인자** | `approver_prep` | 준비위 검토완료 건 최종 승인/반려 (≤한도) |
| **운영 위원장** | `session_director` | 운영위 최종 승인/반려 (금액 무제한), 대시보드, 정산 열람 |
| **준비 위원장** | `logistic_admin` | 준비위 최종 승인/반려 (금액 무제한), 대시보드, 정산 열람 |
| **대회장** | `executive` | 모든 위원회 최종 승인/반려 (금액 무제한), 대시보드, 정산 열람 |
| **관리자** | `admin` | 전체 권한 + 프로젝트 관리 + 사용자 삭제 |

### 권한별 기능 매트릭스

| 기능 | `finance_ops` | `finance_prep` | `approver_ops` | `approver_prep` | `session_director` | `logistic_admin` | `executive` | `admin` |
|------|:-----------:|:-----------:|:------------:|:-------------:|:---------------:|:--------------:|:---------:|:-----:|
| 검토 (운영) | O | O | - | - | - | - | - | O |
| 검토 (준비) | - | O | - | - | - | - | - | O |
| 승인 (운영, ≤한도) | - | - | O | - | O | - | O | O |
| 승인 (운영, >한도) | - | - | - | - | O | - | O | O |
| 승인 (준비, ≤한도) | - | - | - | O | - | O | O | O |
| 승인 (준비, >한도) | - | - | - | - | - | O | O | O |
| 대시보드 | - | O | - | - | O | O | O | O |
| 정산 열람 | - | O | O | O | O | O | O | O |
| 정산 처리 | - | O | - | - | - | - | - | O |
| 영수증 관리 | - | O | - | - | - | - | - | O |
| 사용자 관리 | - | O | - | - | - | - | - | O |
| 사용자 삭제 | - | - | - | - | - | - | - | O |
| 강제 반려 | - | O | - | - | - | - | - | O |

### 3단계 승인 워크플로우

신청서는 **3단계**(신청 → 재정 검토 → 최종 승인)를 거칩니다.

#### 1단계: 재정 검토 (재정 담당자)

1. 상단 메뉴에서 **신청 관리**를 클릭합니다.
2. **대기중** 탭에서 검토할 신청서를 확인합니다.
3. **검토완료** 또는 **반려** 버튼을 클릭합니다.
   - 검토완료: 신청서가 **검토완료** 상태로 전환되며, 해당 위원회 승인자에게 이메일 알림이 발송됩니다.
   - 반려: 반려 사유를 입력하면 신청자에게 이메일 알림이 발송됩니다.
   - 본인이 신청한 건은 검토할 수 없습니다.

#### 2단계: 최종 승인 (승인자, 위원장, 대회장, 관리자)

1. **검토완료** 탭에서 승인할 신청서를 확인합니다.
2. **승인** 또는 **반려** 버튼을 클릭합니다.
   - 승인: 서명 모달에서 서명 후 승인합니다. 신청자에게 이메일 알림이 발송됩니다.
   - 반려: 반려 사유를 입력합니다.
   - 60만원 초과 신청은 위원장, 대회장 또는 관리자만 승인할 수 있습니다.

#### 승인건 반려 (정산 전 오류 발견 시)

준비위 재정(총괄) 또는 관리자는 정산 페이지에서 승인된 신청서의 오류를 발견한 경우 **반려** 처리할 수 있습니다. 신청자에게 이메일 알림이 발송되며, 재신청이 가능합니다.

### 영수증 관리 (준비위 재정, 관리자)

1. 상단 메뉴에서 **영수증 관리**를 클릭합니다.
2. 전체 신청서의 영수증을 한눈에 조회할 수 있습니다.
3. 개별 영수증을 확인하거나 ZIP으로 일괄 다운로드할 수 있습니다.

### 정산 (준비위 재정, 관리자)

승인된 신청서들을 신청자별로 정산 처리하고 통합 리포트를 생성합니다.

#### 정산 처리

1. 상단 메뉴에서 **정산**을 클릭합니다.
2. **새 정산 처리** 버튼을 클릭합니다.
3. 승인 완료된 신청서 목록에서 체크박스로 선택합니다.
4. **선택 항목 정산** 버튼을 클릭합니다.
5. 신청자별로 자동 그룹핑되어 **개별 리포트**가 생성됩니다.
6. 승인 서명이 없는 건은 정산할 수 없습니다.

#### 정산 리포트

리포트 내용:
- 신청자 정보 (이름, 전화번호, 은행/계좌)
- 정산일 (리포트 생성일)
- 통합된 항목 목록 및 합계
- 영수증 목록
- **Requested by** - 신청자 이름
- **Approved by** - 승인자 서명 + 이름
- **Area Office Finance Verification** - 문서번호, 서명란, 승인일, 비고란

#### PDF 내보내기

1. 정산 리포트에서 **PDF 내보내기** 버튼을 클릭합니다.
2. 리포트 + 영수증 이미지 + 서명 + 재정부 확인란이 포함된 PDF가 생성됩니다.
3. 브라우저 인쇄 대화상자에서 "PDF로 저장"을 선택합니다.

### 대시보드 (준비위 재정, 위원장, 대회장, 관리자)

1. 상단 메뉴에서 **대시보드**를 클릭합니다.
2. 확인할 수 있는 정보:
   - **요약 카드** - 전체/대기/승인/반려 건수 및 금액
   - **예산 현황** - 총 예산 대비 사용률 차트 (시계열 영역 차트)
   - **위원회별 현황** - 운영/준비 위원회별 바 차트
   - **예산 코드별 현황** - 코드별 승인액 vs 배정 예산 바 차트 (초과 시 빨간색)
   - **신청 추이** - 일별(14일)/월별 신청 추이 차트 (토글 전환)
3. **예산 설정** - 총 예산, 코드별 예산, 예산 경고 기준(%), 위원장 승인 금액 기준을 설정/수정할 수 있습니다.

> 예산 사용률이 경고 기준을 초과하면 신청서 작성 및 관리 페이지에 경고 배너가 표시됩니다.

### 사용자 관리 (관리자)

1. 상단 메뉴에서 **사용자 관리**를 클릭합니다.
2. 전체 사용자 목록이 표시됩니다.
3. 드롭다운으로 권한을 변경할 수 있습니다 (일반/운영위 재정/운영위 승인자/준비위 재정(총괄)/준비위 승인자/운영 위원장/준비 위원장/대회장/관리자).
4. 본인의 권한은 변경할 수 없습니다.
5. 관리자는 사용자를 삭제할 수 있습니다 (본인 제외).

---

## 전체 워크플로우

```
[신청자]      신청서 작성 → 제출 (대기중)
                  ↓
[재정 담당]   신청 관리에서 검토 → 영수증/통장사본 확인 → 검토완료 (또는 반려)
                  ↓
[승인자]      검토완료 건 확인 → 서명 후 최종 승인 (또는 반려)
                  ↓
[재정 총괄]   정산 → 승인건 선택 → 정산 처리 (오류 발견 시 반려 가능)
                  ↓
[신청자]      내 신청 내역에서 "정산완료" 상태 확인
```

### 이메일 알림

| 시점 | 수신자 | 내용 |
|------|--------|------|
| 신청서 생성 | 해당 위원회 재정 담당자 | 검토 요청 |
| 검토완료 (pending→reviewed) | 해당 위원회 승인자/위원장, 대회장 | 승인 요청 |
| 승인 (reviewed→approved) | 신청자 | 승인 알림 |
| 반려 (→rejected) | 신청자 | 반려 사유 |
| 승인건 반려 (approved→force_rejected) | 신청자 | 반려 사유 |
| 매주 일요일 | 재정 담당 → 검토 대기 건수, 승인자 → 승인 대기 건수 |

---

## 다국어 지원

설정 페이지에서 한국어/English를 전환할 수 있습니다. 브라우저 언어를 자동 감지하며, 선택한 언어는 저장됩니다.

위원회 영어 명칭:
- 운영 위원회 → Session Committee
- 준비 위원회 → Logistical Committee

---

## 배포

`main` 브랜치에 push하면 GitHub Actions를 통해 Firebase Hosting 및 Cloud Functions가 자동 배포됩니다. 수동 배포도 가능합니다.

자세한 설정, 배포, CI/CD 및 Mock 데이터에 대한 내용은 [SETUP.md](./SETUP.md)를 참고하세요.
